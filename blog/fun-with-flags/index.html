<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Don&#39;t panic">

<base href="https://www.nolife4life.org/">
<title>


     Fun with flags 

</title>
<link rel="canonical" href="https://www.nolife4life.org/blog/fun-with-flags/">


<script type="text/javascript">
    var baseURL = 'https:\/\/www.nolife4life.org\/';
    var host = baseURL.substring(0, baseURL.length - 1).replace(/\//g, '');
    if ((host === window.location.host) && (window.location.protocol !== 'https:')) {
        window.location.protocol = 'https:';
    }
</script>



<link rel="stylesheet" href="https://www.nolife4life.org/css/reset.css">
<link rel="stylesheet" href="https://www.nolife4life.org/css/syntax.css">
<link rel="stylesheet" href="https://www.nolife4life.org/css/main.css">






<link rel="shortcut icon"

    href="https://www.nolife4life.org/img/favicon.ico"

>



</head>


<body lang="en">

<section class="header">
    <div class="container">
        <div class="content">
            <a href="https://www.nolife4life.org/"><div class="name">xytis</div></a>
            <nav>
                <ul>
                    <a href="https://www.nolife4life.org/blog/"><li>Blog</li></a>
                    <a href="https://www.nolife4life.org/about/"><li>About</li></a>
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
            <a href="https://github.com/xytis" target="_blank">
                <i class="icon ion-social-github"></i>
            </a>
        

        

        

        

        

        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Fun with flags

</div>

                    <div class="initials"><a href="https://www.nolife4life.org/"></a></div>
                </div>
                <div class="meta">
                    <div class="date" title="Fri Oct 11 2013 12:00:00 &#43;0200">Oct 11, 2013</div>
                    <div class="reading-time"><div class="middot"></div>3 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                <p>Every now and then I catch myself in such situation:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">enum</span> <span class="n">Alignment</span> <span class="p">{</span>
  <span class="n">Left</span><span class="p">,</span> <span class="n">Center</span><span class="p">,</span> <span class="n">Right</span><span class="p">,</span> <span class="n">Justify</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">Anchor</span> <span class="p">{</span>
  <span class="n">Top</span><span class="p">,</span> <span class="n">Right</span><span class="p">,</span> <span class="n">Bottom</span><span class="p">,</span> <span class="n">Left</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">SetAnchor</span><span class="p">(</span><span class="n">byte</span> <span class="n">anchor</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">SetAlignment</span><span class="p">(</span><span class="n">byte</span> <span class="n">alignment</span><span class="p">);</span>
</code></pre></div>
<p>This just begs for errors. So what can we do here? Obvious answer &ndash; lets make a class, with overloaded <code>operator|</code> and <em>voilia</em>, we just created a type safe flag implementation.
This time I wanted to do something different, in a way, that performance of these flags would match (in some extent) natural binary operations.</p>

<p>So the goals for today:</p>

<ul>
<li><p>Syntax:</p>

<p>{% codeblock lang:cpp %}
auto alignment = Alignment::Justify | Alignment::Right;
SetAnchor(Anchor::Top | Anchor::Right); {% endcodeblock %}</p></li>

<li><p>Speed:</p>

<p>Should be resolved during compile time most of the time and with the same speed as std::bitset when performing in runtime.</p></li>

<li><p>Ease of defining:</p>

<p>I liked the way <a href="http://molecularmusings.wordpress.com/2011/08/23/flags-on-steroids">Molecular</a> defined macros for their flag creation, so I shall do the same.</p></li>
</ul>

<p>Note:
  Code for this post is stored at <a href="https://github.com/xytis/mad-flag">GitHub</a></p>

<p>Since I want compile time evaluation, I must somehow store the expressions <code>a | b | c</code> as types. Naturally this can be achieved using lists: <code>a | (b | c)</code>, where <code>b | c</code> creates a compound type.</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp">  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">state</span> <span class="o">=</span> <span class="nb">true</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">flag</span> <span class="p">{</span>
    <span class="k">constexpr</span> <span class="n">flag</span><span class="p">()</span> <span class="p">{}</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">lhs_t</span><span class="p">,</span> <span class="k">typename</span> <span class="n">rhs_t</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">flag_group</span> <span class="p">{</span>
    <span class="n">lhs_t</span> <span class="o">&amp;</span> <span class="n">lhs</span><span class="p">;</span>
    <span class="n">rhs_t</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">;</span>
  <span class="p">};</span>
</code></pre></div>
<p>These types can be nested using these operations:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="k">auto</span> <span class="k">operator</span> <span class="o">|</span> <span class="p">(</span><span class="n">left_flag_t</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="p">...</span><span class="o">&gt;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">right_flag_t</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="p">...</span><span class="o">&gt;</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">flag_group</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">decltype</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span> <span class="k">decltype</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">static_assert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;Flag type missmatch!&#34;</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="k">auto</span> <span class="k">operator</span> <span class="o">|</span> <span class="p">(</span><span class="n">left_group_type</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="p">...</span><span class="o">&gt;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">right_flag_t</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="p">...</span><span class="o">&gt;</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">flag_group</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">decltype</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span> <span class="k">decltype</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">static_assert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;Flag type missmatch!&#34;</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="k">auto</span> <span class="k">operator</span> <span class="o">|</span> <span class="p">(</span><span class="n">left_group_type</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="p">...</span><span class="o">&gt;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">right_group_type</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="p">...</span><span class="o">&gt;</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">flag_group</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">decltype</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span> <span class="k">decltype</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">static_assert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="s">&#34;Flag type missmatch!&#34;</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>Resulting object from operation <code>a | b | c</code> contains all expression flags, carefully nested in a compile time defined tree. Now how do we use them in orderly fashion?</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">Anchor</span> <span class="p">{</span>
    <span class="k">typedef</span> <span class="k">struct</span><span class="p">{}</span> <span class="n">_guard</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">Flags</span><span class="o">::</span><span class="n">field</span><span class="o">&lt;</span><span class="n">_guard</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">State</span><span class="p">;</span>
    <span class="k">constexpr</span> <span class="n">Flags</span><span class="o">::</span><span class="n">flag</span><span class="o">&lt;</span><span class="n">_guard</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="n">Top</span><span class="p">;</span>
    <span class="k">constexpr</span> <span class="n">Flags</span><span class="o">::</span><span class="n">flag</span><span class="o">&lt;</span><span class="n">_guard</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">Right</span><span class="p">;</span>
    <span class="k">constexpr</span> <span class="n">Flags</span><span class="o">::</span><span class="n">flag</span><span class="o">&lt;</span><span class="n">_guard</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">Bottom</span><span class="p">;</span>
    <span class="k">constexpr</span> <span class="n">Flags</span><span class="o">::</span><span class="n">flag</span><span class="o">&lt;</span><span class="n">_guard</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">Left</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Here the namespace serves as a syntactic container for flags and for magical guard struct. The type of the struct is unique (as long as there are only a single definition of a namespace named Anchor with an empty struct) and can be used by compiler while resolving templates to imply type safety on the flags.
State typedef in the namespace is used to create flag containers.</p>

<p>After using the same macro magic as in Molecular engine, flags can be used like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">FLAGS</span><span class="p">(</span><span class="n">PlayerState</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">idle</span><span class="p">,</span> <span class="n">damaged</span><span class="p">,</span> <span class="n">jumping</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">PlayerState</span><span class="p">;</span>
    <span class="n">State</span> <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">();</span>

    <span class="n">state</span> <span class="o">|=</span> <span class="n">active</span> <span class="o">|</span> <span class="n">jumping</span> <span class="o">|</span> <span class="n">idle</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ToString</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        
    <span class="k">auto</span> <span class="n">argument</span> <span class="o">=</span> <span class="n">damaged</span> <span class="o">|</span> <span class="o">!</span><span class="n">jumping</span><span class="p">;</span>
    <span class="n">state</span> <span class="o">|=</span> <span class="n">argument</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ToString</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
                <br>
                <p><a href="https://www.nolife4life.org/blog/">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
        </div>
    </div>
</section>





</body>
</html>

